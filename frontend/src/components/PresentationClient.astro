---
import SafePresentation from "./SafePresentation.astro";
import CompareView from "./CompareView.astro";
import ThankYouView from "./ThankYouView.astro";

let cliente = "";
let cotizaciones = [];
let campos = [];

const API_URL = import.meta.env.PUBLIC_API_URL || "https://safesound-b8as.onrender.com";

---

<main class="print-page flex flex-col items-center bg-[#E6EDF0]">
  <!-- üîπ Contenedor din√°mico -->
  <div id="presentation-content" class="flex flex-col items-center gap-10 w-full">
    <!-- Carga inicial (placeholder visual) -->
    <p class="text-[#004C3F]/60 py-10">Cargando presentaci√≥n personalizada‚Ä¶</p>
  </div>
</main>

<!-- Bot√≥n fijo de descarga -->
<button
  id="download-pdf"
  class="fixed bottom-6 right-6 z-50 bg-safesound-primary hover:bg-safesound-secondary text-white font-semibold px-5 py-3 rounded-xl shadow-lg"
>
  üìÑ Descargar PDF
</button>

<script type="module">
  // Backend fijo por ahora
  const API_URL = "https://safesound-b8as.onrender.com";

  async function postHTML(url, formData) {
    const res = await fetch(url, { method: "POST", body: formData });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.text();
  }

  // üîπ Render din√°mico de presentaci√≥n
  (async () => {
    const raw = localStorage.getItem("comparativoData");
    if (!raw) {
      console.warn("‚ö†Ô∏è No hay comparativoData en localStorage");
      return;
    }

    const data = JSON.parse(raw);
    const { cliente = "", cotizaciones = [], campos = [] } = data;

    const f1 = new FormData();
    f1.append("cliente", cliente);
    const html1 = await postHTML(`${API_URL}/partial/safe-presentation`, f1);

    const f2 = new FormData();
    f2.append("cotizaciones", JSON.stringify(cotizaciones));
    f2.append("campos", JSON.stringify(campos));
    f2.append("titulo", "Comparativo de Seguros");
    const html2 = await postHTML(`${API_URL}/partial/compare-view`, f2);

    const html3 = await (await fetch(`${API_URL}/partial/thankyou-view`)).text();

    const fullHTML = `
      <div class="flex flex-col items-center">
          <div class="mb-[80px]">${html1}</div>
          <div class="my-[100px]">${html2}</div>
          <div class="mt-[120px]">${html3}</div>
      </div>
    `;

    document.getElementById("presentation-content").innerHTML = fullHTML;

    const marker = document.createElement("div");
    marker.id = "pdf-ready";
    marker.style.display = "none";
    document.body.appendChild(marker);
    console.log("‚úÖ Marcador #pdf-ready insertado");
  })().catch(err => {
    console.error("‚ùå Error cargando presentaci√≥n din√°mica:", err);
  });

  // üîπ Bot√≥n de descarga (mismo API_URL)
  const btn = document.getElementById("download-pdf");

  btn?.addEventListener("click", async () => {
    btn.disabled = true;
    const originalText = btn.innerHTML;
    btn.innerHTML = "‚è≥ Generando PDF...";
    btn.classList.add("opacity-80", "cursor-wait");

    try {
      const raw = localStorage.getItem("comparativoData") || "{}";
      const { cliente = "cliente" } = JSON.parse(raw);

      const res = await fetch(`${API_URL}/generate-pdf`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: raw,
      });

      if (!res.ok) throw new Error("Error en generaci√≥n de PDF");

      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `comparativo_${cliente}.pdf`;
      a.click();
      URL.revokeObjectURL(url);

      btn.innerHTML = "‚úÖ PDF listo";
      btn.classList.remove("cursor-wait");
      btn.classList.add("bg-green-600");

      setTimeout(() => {
        btn.innerHTML = originalText;
        btn.classList.remove("bg-green-600", "opacity-80");
        btn.disabled = false;
      }, 2500);
    } catch (err) {
      console.error(err);
      btn.innerHTML = "‚ùå Error al generar";
      btn.classList.add("bg-red-600");

      setTimeout(() => {
        btn.innerHTML = originalText;
        btn.classList.remove("bg-red-600", "opacity-80");
        btn.disabled = false;
      }, 2500);
    }
  });
</script>

