---
export const prerender = false;
import CompareTable from "../components/CompareTable.astro";
---

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Safe & Sound | Comparativo</title>
  </head>
  <body>
    <section class="mx-auto max-w-6xl px-4 py-10 text-center">
      <!-- üü¢ Logo -->
      <div class="flex justify-center mb-6">
        <img
          src="/logos/sslogo.png"
          alt="Safe&Sound Agente de Seguros"
          class="w-1/2 max-w-[240px] h-auto object-contain mx-auto"
          loading="lazy"
        />
      </div>

      <h1 class="mb-6 text-2xl font-bold text-safesound-primary">
        Generar comparativo de seguros
      </h1>

      <!-- üßæ Formulario principal -->
      <form id="compare-form" class="mb-8 rounded-xl border border-safesound-primary/30 bg-safesound-light/20 p-5 space-y-6 text-left">

        <!-- üßç Nombre del cliente -->
        <div>
          <label for="cliente" class="block text-safesound-dark font-semibold mb-1">
            Nombre del cliente
          </label>
          <input
            type="text"
            id="cliente"
            name="cliente"
            placeholder="Ejemplo: Iv√≥n Jim√©nez"
            class="w-full rounded-lg border border-safesound-primary/30 bg-white/90 p-2 text-safesound-dark placeholder:text-safesound-dark/50"
            required
          />
        </div>

        <!-- ü©∫ Tipo de seguro -->
        <div>
          <label for="tipo_seguro" class="block text-safesound-dark font-semibold mb-1">
            Tipo de seguro
          </label>
          <select
            id="tipo_seguro"
            name="tipo_seguro"
            class="w-full rounded-lg border border-safesound-primary/30 bg-white/90 p-2 text-safesound-dark"
            required
          >
            <option value="" disabled selected>Selecciona una opci√≥n</option>
            <option value="auto">Auto</option>
            <option value="hogar">Hogar</option>
            <option value="gmmi">Gastos M√©dicos Mayores</option>
            <option value="vida">Vida</option>
          </select>
        </div>

        <!-- üí≥ Periodo de pago -->
        <div>
          <label for="periodo_pago" class="block text-safesound-dark font-semibold mb-1">
            Periodo de pago
          </label>
          <select
            id="periodo_pago"
            name="periodo_pago"
            class="w-full rounded-lg border border-safesound-primary/30 bg-white/90 p-2 text-safesound-dark"
          >
            <option value="anual" selected>Anual</option>
            <option value="semestral">Semestral</option>
            <option value="trimestral">Trimestral</option>
            <option value="mensual">Mensual</option>
          </select>
        </div>

        <!-- üìé Carga de PDFs -->
        <div>
          <label class="block text-safesound-dark font-semibold mb-2">Cotizaciones PDF</label>
          <div
            id="dropzone"
            class="relative flex flex-col items-center justify-center w-full p-8 border-2 border-dashed rounded-2xl 
                   border-safesound-primary/40 bg-safesound-light/10 hover:bg-safesound-light/20 
                   transition cursor-pointer group"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-12 h-12 text-safesound-primary mb-3 group-hover:scale-105 transition-transform"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M7 16V8m0 0l-4 4m4-4l4 4M20 16v-8m0 0l-4 4m4-4l4 4" />
            </svg>
            <p class="text-sm text-safesound-dark/80 font-medium">
              <span class="text-safesound-primary font-semibold">Arrastra y suelta</span> tus cotizaciones PDF aqu√≠<br/>
              o <span class="underline text-safesound-primary">haz clic para seleccionar</span>
            </p>
            <input
              id="files"
              name="files"
              type="file"
              multiple
              accept="application/pdf"
              class="absolute inset-0 opacity-0 cursor-pointer"
            />
          </div>
          <ul id="fileList" class="mt-4 space-y-2 text-sm text-safesound-dark/90"></ul>
        </div>

        <!-- üöÄ Bot√≥n -->
        <button
          type="button"
          id="submitBtn"
          class="w-full bg-safesound-primary hover:bg-safesound-secondary text-white font-semibold py-3 rounded-xl shadow-soft transition"
        >
          Analizar PDFs y Generar Comparativo
        </button>

        <p id="status" class="mt-3 text-sm text-safesound-dark/80"></p>

        <!-- Barra de progreso -->
        <div id="progress-container" class="hidden mt-4 w-full bg-white/40 rounded-full overflow-hidden h-4">
          <div id="progress-bar" class="h-4 bg-safesound-primary transition-all duration-300 ease-out" style="width: 0%;"></div>
        </div>
      </form>
    </section>

    <!-- üü¢ Splash de carga -->
<div
  id="splash"
  class="fixed inset-0 hidden items-center justify-center bg-gradient-to-br from-[#EEF5E8] to-[#E6EDF0] z-50 flex-col"
>
  <img
    src="/logos/sslogo.png"
    alt="Safe & Sound"
    class="w-28 h-auto mb-6 animate-fade-in"
  />
  <h2 class="text-2xl font-bold text-[#004C3F] mb-2 font-[Figtree]">
    Generando tu presentaci√≥n‚Ä¶
  </h2>
  <p class="text-[#004C3F]/70 text-sm font-[Figtree] mb-6">
    Esto puede tardar unos segundos
  </p>
  <div class="relative w-64 h-2 bg-white/40 rounded-full overflow-hidden">
    <div
      id="splash-progress"
      class="absolute left-0 top-0 h-2 bg-[#007A57] w-0 transition-all duration-300 ease-out"
    ></div>
  </div>
</div>


  <!-- üü¢ Splash de carga -->
<div
id="splash"
class="fixed inset-0 hidden items-center justify-center bg-gradient-to-br from-[#EEF5E8] to-[#E6EDF0] z-50 flex-col"
>
  <img
    src="/logos/sslogo.png"
    alt="Safe & Sound"
    class="w-28 h-auto mb-6 animate-fade-in"
  />
  <h2 class="text-2xl font-bold text-[#004C3F] mb-2 font-[Figtree]">
    Generando tu presentaci√≥n‚Ä¶
  </h2>
  <p class="text-[#004C3F]/70 text-sm font-[Figtree] mb-6">
    Esto puede tardar unos segundos
  </p>
  <div class="relative w-64 h-2 bg-white/40 rounded-full overflow-hidden">
    <div
      id="splash-progress"
      class="absolute left-0 top-0 h-2 bg-[#007A57] w-0 transition-all duration-300 ease-out"
    >
    </div>
  </div>
</div>



  </body>
</html>

<script type="module">
  const btn = document.getElementById("submitBtn");
  const input = document.getElementById("files");
  const status = document.getElementById("status");
  const progressContainer = document.getElementById("progress-container");
  const progressBar = document.getElementById("progress-bar");
  const API_URL = import.meta.env.PUBLIC_API_URL || "http://127.0.0.1:8080";

  btn?.addEventListener("click", async () => {
    const files = input?.files;
    const cliente = document.getElementById("cliente").value.trim();
    const tipoSeguro = document.getElementById("tipo_seguro").value;
    const periodoPago = document.getElementById("periodo_pago").value;

    if (!cliente || !tipoSeguro) {
      status.textContent = "Completa el nombre del cliente y el tipo de seguro.";
      return;
    }

    if (!files || files.length < 2) {
      status.textContent = "Sube al menos 2 PDFs.";
      return;
    }

    status.textContent = "Analizando PDFs‚Ä¶";
    progressContainer.classList.remove("hidden");
    progressBar.style.width = "0%";

    const fd = new FormData();
    fd.append("cliente", cliente);
    fd.append("tipo_seguro", tipoSeguro);
    fd.append("periodo_pago", periodoPago);
    for (const f of files) fd.append("files", f);

    try {
      const xhr = new XMLHttpRequest();
      xhr.open("POST", `${API_URL}/compare`, true);

      xhr.upload.onprogress = (event) => {
        if (event.lengthComputable) {
          const percent = Math.min((event.loaded / event.total) * 100, 90);
          progressBar.style.width = `${percent.toFixed(1)}%`;
          status.textContent = `Procesando cotizaciones‚Ä¶ ${percent.toFixed(0)}%`;
        }
      };

      xhr.onreadystatechange = async () => {
        if (xhr.readyState === XMLHttpRequest.DONE) {
          if (xhr.status === 200) {
            progressBar.style.width = "100%";
            setTimeout(() => progressContainer.classList.add("hidden"), 800);

            const data = JSON.parse(xhr.responseText);
            console.log("üì¶ Datos recibidos del backend:", data);

            status.textContent = data?.mensaje || "Comparativo generado.";

            // üß† Guardar en localStorage y redirigir a la presentaci√≥n
            localStorage.setItem("comparativoData", JSON.stringify(data));
            console.log("‚úÖ Datos guardados en localStorage:", data);

            // ü™Ñ Mostrar splash
            const splash = document.getElementById("splash");
            const splashProgress = document.getElementById("splash-progress");

            splash.classList.remove("hidden");
            document.body.classList.add("overflow-hidden");

            let splashPercent = 0;
            const splashTimer = setInterval(() => {
              splashPercent = Math.min(splashPercent + 2, 100);
              splashProgress.style.width = `${splashPercent}%`;
              if (splashPercent >= 100) {
                clearInterval(splashTimer);
                setTimeout(() => {
                  window.location.href = "/presentacion";
                }, 400);
              }
            }, 80);


          } else {
            status.textContent = `Error HTTP ${xhr.status}`;
            progressContainer.classList.add("hidden");
          }
        }
      };

      xhr.onerror = () => {
        status.textContent = "‚ùå Error al conectar con el servidor.";
        progressContainer.classList.add("hidden");
      };

      xhr.send(fd);

      // Simulaci√≥n de progreso durante el procesamiento
      let fake = 90;
      const timer = setInterval(() => {
        if (progressBar.style.width === "100%") return clearInterval(timer);
        fake = Math.min(fake + 1, 95);
        progressBar.style.width = `${fake}%`;
      }, 500);
    } catch (e) {
      console.error("‚ùå Error en el flujo compare:", e);
      status.textContent = "Error al procesar los PDFs.";
      progressContainer.classList.add("hidden");
    }
  });

  // üóÇÔ∏è Vista previa de archivos seleccionados
  const fileInput = document.getElementById("files");
  const fileList = document.getElementById("fileList");

  fileInput.addEventListener("change", () => {
    fileList.innerHTML = "";
    for (const file of fileInput.files) {
      const li = document.createElement("li");
      li.className =
        "flex items-center justify-between rounded-lg border border-safesound-primary/20 bg-white/30 backdrop-blur px-3 py-2";
      li.innerHTML = `
        <span class="truncate max-w-[80%]">${file.name}</span>
        <span class="text-xs text-safesound-primary">${(file.size / 1024).toFixed(1)} KB</span>
      `;
      fileList.appendChild(li);
    }
  });
</script>
